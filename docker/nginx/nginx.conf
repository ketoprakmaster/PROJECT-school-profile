# nginx/nginx.conf
proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=cache_zone:10m max_size=1g inactive=60m use_temp_path=off;

upstream django_app {
    # This points to the hostname and port of your 'web' service
    server web:8000;
}

server {
    listen 80;
    server_name localhost;

    # --- 1. GZIP Compression Settings ---
    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_comp_level 5; 
    gzip_proxied any; 
    
    # Compress all standard web types
    gzip_types
        text/css
        text/javascript
        text/xml
        text/plain
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml
        application/vnd.ms-fontobject
        application/x-font-ttf
        font/opentype;
    

    # --- 2. Static Files (Serving and Caching) ---
    location /static/ {
        alias /app/static/;
        
        expires 90d;
        access_log off;
        add_header Cache-Control "public";
    }

    # --- 3. Media Files (Serving and Caching) ---
    location /media/ {
        alias /app/media/;
        
        expires 30d;
        add_header Cache-Control "public";
    }

    # --- 4. Dynamic Requests (Proxying) ---
    location / {
        proxy_pass http://django_app;

        # --- Micro-Caching Settings ---
        proxy_cache cache_zone;   
        proxy_cache_valid 200 5s;        
        proxy_cache_revalidate on;      
        proxy_cache_use_stale error timeout updating;
        
        # Bypass cache for authenticated users
        proxy_cache_bypass $cookie_sessionid $http_authorization; 
        proxy_no_cache $cookie_sessionid $http_authorization; 

        
        # Standard proxy headers
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }
}